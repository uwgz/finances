{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='js/charts.js') }}" defer></script>

{% endblock %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="dashboard">
    <h2>Welcome, {{ session['username'] }}!</h2>
    
    <div class="summary-cards">
        <div class="summary-card">
            <h3>Current Balance</h3>
            <p class="amount {% if balance >= 0 %}positive{% else %}negative{% endif %}">
                ${{ "%.2f"|format(balance) }}
            </p>
        </div>
        <div class="summary-card">
            <h3>Total Income</h3>
            <p class="amount positive">${{ "%.2f"|format(total_income) }}</p>
        </div>
        <div class="summary-card">
            <h3>Total Expenses</h3>
            <p class="amount negative">${{ "%.2f"|format(total_expenses) }}</p>
        </div>
    </div>
    
    <div class="quick-actions">
        <a href="{{ url_for('add_transaction') }}" class="btn">
            <i class="fas fa-plus"></i> Add Transaction
        </a>
        <a href="{{ url_for('transactions') }}" class="btn btn-secondary">
            <i class="fas fa-list"></i> View All Transactions
        </a>
    </div>
    
    <!-- Hidden element to store chart data -->
    <div id="chart-data" 

         data-monthly="{{ {
             'labels': monthly_data|map(attribute='month')|list,
             'income': monthly_data|map(attribute='income')|list,
             'expenses': monthly_data|map(attribute='expense')|list
         }|tojson }}"
         data-income="{{ {
             'labels': income_by_category.keys()|list,
             'values': income_by_category.values()|list
         }|tojson }}"
         data-expenses="{{ {
             'labels': expenses_by_category.keys()|list,
             'values': expenses_by_category.values()|list
         }|tojson }}">
    </div>
    
    <div class="charts-container">
        <div class="chart-card">
            <h3>Monthly Trends</h3>
            <div class="chart-container">
                <canvas id="monthlyTrendsChart"></canvas>
            </div>
        </div>
        
        <div class="chart-card">
            <h3>Income Breakdown</h3>
            <div class="chart-container">
                <canvas id="incomeChart"></canvas>
            </div>
        </div>
        
        <div class="chart-card">
            <h3>Expenses Breakdown</h3>
            <div class="chart-container">
                <canvas id="expensesChart"></canvas>
            </div>
        </div>
    </div>
    
    <div class="recent-transactions">
        <h3>Recent Transactions</h3>
        {% if recent_transactions %}
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Description</th>
                        <th>Category</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody>
                    {% for transaction in recent_transactions %}
                    <tr>
                        <td>{{ transaction.date.strftime('%Y-%m-%d') }}</td>
                        <td>{{ transaction.description }}</td>
                        <td>{{ transaction.category }}</td>
                        <td class="{% if transaction.type == 'income' %}positive{% else %}negative{% endif %}">
                            {% if transaction.type == 'income' %}+{% else %}-{% endif %}${{ "%.2f"|format(transaction.amount) }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>No transactions yet. <a href="{{ url_for('add_transaction') }}">Add your first transaction</a></p>
        {% endif %}
    </div>
</div>
{% endblock %}